---
title: "Progress Report"
author: "Margaret Shepherd, Anina Peersen"
date: 'December 5, 2022'
output: html_document
---

<style>
body {
text-align: justify}
</style> 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

Fires = read.csv("FW_Veg_Rem_Combined.csv")
library(ggplot2)
library(tidyverse)
library(maps)
library(ggmap)
library(ggthemes)
library(usdata)
library(lubridate)
library(stringr)
library(usmap)
```

```{r, echo = FALSE}
FiresClean <- Fires %>%
  mutate(discovery_month = fct_relevel(discovery_month, c('Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec')), 
         disc_pre_month = fct_relevel(disc_pre_month, c('Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec')), 
         days_to_containment =  str_remove(putout_time, "\\ .*")) %>%
  mutate(fire_size_class = factor(fire_size_class), 
         stat_cause_descr = factor(stat_cause_descr), 
         state = factor(state), 
         vegCat = case_when(Vegetation %in% c(1, 2, 3, 4, 5, 6, 7, 16, 17, 18, 19, 20, 21, 22) ~ 'forest', 
                            Vegetation %in% c(24, 25, 26, 27) ~ 'agricultural', 
                            Vegetation == 28 ~ 'urban', 
                            Vegetation == 23 ~ 'water', 
                            Vegetation == 13 ~ 'tundra', 
                            Vegetation %in% c(14, 15) ~ 'desert', 
                            Vegetation %in% c(9, 10) ~ 'grassland',
                            Vegetation %in% c(11, 12) ~ 'shrubland', 
                            Vegetation == 8 ~ 'savanna', 
                            Vegetation == 0 ~ 'unknown'), 
         forestType = case_when(Vegetation %in% c(2, 5, 7, 17, 20, 22) ~ 'deciduous', 
                                Vegetation %in% c(1, 3, 4, 6, 16, 18, 19, 21) ~ 'evergreen'), 
         forestLeafType = case_when(Vegetation %in% c(1, 2, 3, 5, 16, 17, 18, 20) ~ 'broadleaf', 
                                    Vegetation %in% c(4, 6, 7, 19, 21, 22) ~ 'needleleaf'), 
         causeCat = case_when(stat_cause_descr %in% c('Arson') ~ 'Intentional Human Action', 
                              stat_cause_descr %in% c('Campfire', 'Children', 'Equipment Use', 'Fireworks', 'Smoking') ~ 'Unintentional Human Action', 
                              stat_cause_descr %in% c('Powerline', 'Railroad', 'Structure') ~ 'Infrastructure', 
                              stat_cause_descr %in% c('Lightning', 'Debris Burning') ~ 'Natural Causes', 
                              stat_cause_descr %in% c('Miscellaneous', 'Missing/Undefined') ~ 'Other'))

FiresClean$disc_clean_date <- as_date(FiresClean$disc_clean_date, format = '%m/%d/%Y')
FiresClean$cont_clean_date <- as_date(FiresClean$cont_clean_date, format = '%m/%d/%Y')
FiresClean$disc_date_pre <- as_date(FiresClean$disc_date_pre, format = '%m/%d/%Y')
FiresClean$disc_date_final <- as_date(FiresClean$disc_date_final, format = '%m/%d/%Y %h:%M')
FiresClean$cont_date_final <- as_date(FiresClean$cont_date_final, format = '%m/%d/%Y %h:%M')
```


```{r, echo = FALSE, include = FALSE}
continentalUS <- get_stamenmap(
  bbox = c(left = -126.47, bottom = 24.21, right = -65.74, top = 49.72),
  maptype = "terrain",
  zoom = 4)

Alaska <- get_stamenmap(
  bbox = c(left = -189.23, bottom = 50.4, right = -129.38, top = 71.52),
  maptype = "terrain",
  zoom = 5)

Hawaii <- get_stamenmap(
  bbox = c(left = -160, bottom = 18.15, right = -154, top = 22.6),
  maptype = "terrain",
  zoom = 7)

PuertoRico <- get_stamenmap(
  bbox = c(left = -67.7, bottom = 17.17, right = -65, top = 19.14),
  maptype = "terrain",
  zoom = 8)
```

### Introduction

```{r, echo = FALSE}
FiresCleanVeg <- FiresClean %>% 
  group_by(vegCat) %>% 
  summarize(num = n())

ggplot(FiresClean, aes(x = vegCat, fill = fire_size_class)) +
  geom_bar(position = 'stack') +
  labs(x = 'Surrounding Vegetation',
       y = 'Number of Fires',
       title = 'Number of Fires by Surrounding Vegetation and Fire Size Classification') + 
  theme_minimal()

ggplot(FiresClean, aes(x = vegCat, fill = fire_size_class)) +
  geom_bar(position = 'fill') +
  labs(x = 'Surrounding Vegetation',
       y = 'Number of Fires',
       title = 'Proportion of Fires Size Classification by Surrounding Vegetation') + 
  theme_minimal()
```


### Spatial Analysis

#### Maps

```{r, echo = FALSE}
# maps of fire locations
ggmap(continentalUS) + 
  geom_point(
    data = FiresClean,
    aes(x = longitude, y = latitude),
    alpha = .4,
    size = 0.2
  ) +
  theme_map()

ggmap(Alaska) + 
  geom_point(
    data = FiresClean,
    aes(x = longitude, y = latitude),
    alpha = .8,
    size = 0.7
  ) +
  theme_map()

ggmap(Hawaii) + 
  geom_point(
    data = FiresClean,
    aes(x = longitude, y = latitude),
    alpha = .8,
    size = 1
  ) +
  theme_map()

ggmap(PuertoRico) + 
  geom_point(
    data = FiresClean,
    aes(x = longitude, y = latitude),
    alpha = .8,
    size = 1
  ) +
  theme_map()
```


```{r, echo = FALSE}
# maps of fire locations and fire magnitude
ggmap(continentalUS) + 
  geom_point(
    data = FiresClean,
    aes(x = longitude, y = latitude, color = fire_mag),
    alpha = .2,
    size = 0.2
  ) +
  theme_map()

ggmap(Alaska) +
  geom_point(
    data = FiresClean,
    aes(x = longitude, y = latitude, color = fire_mag),
    alpha = .8,
    size = 0.7
  ) +
  theme_map()

ggmap(Hawaii) +
  geom_point(
    data = FiresClean,
    aes(x = longitude, y = latitude, color = fire_mag),
    alpha = .8,
    size = 1
  ) +
  theme_map()

ggmap(PuertoRico) +
  geom_point(
    data = FiresClean,
    aes(x = longitude, y = latitude, color = fire_mag),
    alpha = .8,
    size = 1
  ) +
  theme_map()
```

```{r, echo = FALSE}
# maps of fire locations and fire class size
FiresClean_class <- FiresClean %>% 
  mutate(fire_size_class = fct_recode(fire_size_class, "1/4 acre to 10 acres" = "B", 
                            "10 acres to 100 acres" = "C",
                            "100 acres to 300 acres" = "D",
                            "300 acres to 1000 acres" = "E",
                            "1000 acres to 5000 acres" = "F",
                            "5000+ acres" = "G"))
  
ggmap(continentalUS) + 
  geom_point(
    data = FiresClean_class,
    aes(x = longitude, y = latitude, color = fire_size_class),
    alpha = .4,
    size = 0.2
  ) +
  theme_map() +
  guides(color = guide_legend(override.aes = list(size = 4, alpha = 0.8))) +
  theme(legend.position = "right")

ggmap(Alaska) +
  geom_point(
    data = FiresClean_class,
    aes(x = longitude, y = latitude, color = fire_size_class),
    alpha = .8,
    size = 0.7
  ) +
  theme_map() +
  guides(color = guide_legend(override.aes = list(size = 4, alpha = 0.8)))

ggmap(Hawaii) +
  geom_point(
    data = FiresClean_class,
    aes(x = longitude, y = latitude, color = fire_size_class),
    alpha = .8,
    size = 1
  ) +
  theme_map() +
  guides(color = guide_legend(override.aes = list(size = 4, alpha = 0.8)))

ggmap(PuertoRico) +
  geom_point(
    data = FiresClean_class,
    aes(x = longitude, y = latitude, color = fire_size_class),
    alpha = .8,
    size = 1
  ) +
  theme_map() +
  guides(color = guide_legend(override.aes = list(size = 4, alpha = 0.8)))
```

On a state-by-state basis, most wildfires in the US are started by natural causes.

```{r, echo = FALSE}
# MOST COMMON CAUSE OF FIRE BY STATE
FiresCleanState <- FiresClean %>% 
  group_by(state, causeCat) %>% 
  summarize(num_by_cause = n())

FiresCleanGroup <- FiresCleanState %>% 
  group_by(state) %>% 
  filter(num_by_cause == max(num_by_cause)) # need to deal with MA, DE

FiresCleanGroup <- FiresCleanGroup %>%
  ungroup() %>% 
  filter(!state %in% c('DE', 'MA')) %>% # takes out DE and MA
  add_row(state = "DE", # re-adds DE
          causeCat = "Intentional Human Action, Unintentional Human Action, Other", 
          num_by_cause = 3) %>%
  add_row(state = "MA", # re-adds MA
          causeCat = "Unintentional Human Action, Other", 
          num_by_cause = 24) 
  
plot_usmap(data = FiresCleanGroup, values = "causeCat", color = "black") +
  scale_fill_manual(values = c("#1b6c6b","green", "#1ccbd1", "#bcdfc6", "#e8f7eb"),
                    # https://huemint.com/gradient-5/ #00a7a0
                    breaks = c("Natural Causes", 
                               "Other", 
                               "Intentional Human Action", 
                               "Unintentional Human Action, Other",
                               "Intentional Human Action, Unintentional Human Action, Other"),
                    labels = c("Natural Causes: lightning, debris burning", 
                               "Other: miscellaneous, missing/undefined", 
                               "Intentional Human Action: arson", 
                               "Tie: Unintentional Human Action, Other (MA)",
                               "Tie: Intentional Human Action, Unintentional Human Action, Other (DE)"),
                    name = "Cause of Wildfire") +
  theme(legend.position = "right") +
  labs(title = "Most Common Cause of Wildfire by State (1992-2015)", 
       caption = "Data from federal, state, and local fire organizations in the US. \n Graphic made by Margaret Shepherd. \n Unintentional Human Action consists of campfires, children, equipment use, \n fireworks, and smoking.")
```

For most states in the US, the most common cause of wildfires is natural causes. A smaller group of states has “other” as the leading cause, and four states list arson as the most common cause of wildfires. It seems that in most places, we can only control our preparation for and response to wildfires, not whether or not they occur in the first place, but this graph may pinpoint states where wildfire records are unclear or underutilized, and states where the most effective firefighting strategy is tied to crime reduction.

#### Bar Plots

```{r, echo = FALSE}
# large fires
LargeFires_state <- FiresClean %>%
  filter(fire_size_class == "E" | fire_size_class == "F" | fire_size_class == "G") %>% 
  group_by(state) %>% 
  summarize(number = n()) %>% 
  arrange(desc(number)) %>% 
  head(10)

ggplot(LargeFires_state, aes(x = reorder(state, desc(number)), y = number)) +
  geom_col() +
  labs(x = 'State',
       y = 'Number of Large (300+ acres) Wildfires',
       title = 'Top 10 US States with the Most Large Wildfires from 1992-2015')
```


### Temporal Analysis

#### Weather Patterns Before Fire

```{r, echo = FALSE, include = FALSE}
Fires_temp <- FiresClean %>% 
  filter(weather_file != 'File Not Found') %>% 
  filter(Temp_pre_30 != 0) %>% 
  filter(Temp_pre_15 != 0) %>%
  filter(Temp_pre_7 != 0) %>%
  filter(Temp_cont != 0) 
  # filter(Temp_pre_30 != 0 | Temp_pre_15 != 0 | Temp_pre_7 != 0 | Temp_cont != 0) # keeps row if all four temps are nonzero

Fires_wind <- FiresClean %>% 
  filter(weather_file != 'File Not Found') %>%
  filter(Wind_pre_30 != 0) %>% 
  filter(Wind_pre_15 != 0) %>%
  filter(Wind_pre_7 != 0) %>%
  filter(Wind_cont != 0)
  
Fires_hum <- FiresClean %>% 
  filter(weather_file != 'File Not Found') %>%
  filter(Hum_pre_30 != 0) %>% 
  filter(Hum_pre_15 != 0) %>%
  filter(Hum_pre_7 != 0) %>%
  filter(Hum_cont != 0)

Fires_prec <- FiresClean %>% 
  filter(weather_file != 'File Not Found') %>%
  filter(Prec_pre_30 != 0) %>% 
  filter(Prec_pre_15 != 0) %>%
  filter(Prec_pre_7 != 0) %>%
  filter(Prec_cont != 0)

(avgtemp30 = mean(Fires_temp$Temp_pre_30))
(avgtemp15 = mean(Fires_temp$Temp_pre_15))
(avgtemp7 = mean(Fires_temp$Temp_pre_7))
(avgtempcont = mean(Fires_temp$Temp_cont))

(avgwind30 = mean(Fires_wind$Wind_pre_30))
(avgwind15 = mean(Fires_wind$Wind_pre_15))
(avgwind7 = mean(Fires_wind$Wind_pre_7))
(avgwindcont = mean(Fires_wind$Wind_cont))

(avghum30 = mean(Fires_hum$Hum_pre_30))
(avghum15 = mean(Fires_hum$Hum_pre_15))
(avghum7 = mean(Fires_hum$Hum_pre_7))
(avghumcont = mean(Fires_hum$Hum_cont))

(avgprec30 = mean(Fires_prec$Prec_pre_30))
(avgprec15 = mean(Fires_prec$Prec_pre_15))
(avgprec7 = mean(Fires_prec$Prec_pre_7))
(avgpreccont = mean(Fires_prec$Prec_cont))

days_before <- c(30, 15, 7, 0)
temp <- c(avgtemp30, avgtemp15, avgtemp7, avgtempcont)
wind <- c(avgwind30, avgwind15, avgwind7, avgwindcont)
hum <- c(avghum30, avghum15, avghum7, avghumcont)
prec <- c(avgprec30, avgprec15, avgprec7, avgpreccont)
avg_weather <- data.frame(days_before, temp, wind, hum, prec)
```

Decreasing precipitation in the 30 days preceding a wildfire is the most predictive weather phenomenon.

```{r, echo = FALSE}
ggplot(data = avg_weather, aes(x = days_before)) +
  geom_point(aes(y = temp/max(temp), color = "Temperature")) +
  geom_point(aes(y = wind/max(wind), color = "Wind")) +
  geom_point(aes(y = hum/max(hum), color = "Humidity")) +
  geom_point(aes(y = prec/max(prec), color = "Precipitation")) +
  geom_line(aes(y = temp/max(temp), color = "Temperature")) +
  geom_line(aes(y = wind/max(wind), color = "Wind")) +
  geom_line(aes(y = hum/max(hum), color = "Humidity")) +
  geom_line(aes(y = prec/max(prec), color = "Precipitation")) + 
  xlim(30, 0) +
  labs(x = 'Number of Days Before a Wildfire',
       y = 'Normalized Average Weather at Wildfire Location',
       title = 'Average Temperature, Wind Speed, Humidity, and Precipitation Before a Wildfire \n Wildfires in the US, 1992-2015',
       color = "Weather") +
  scale_color_manual(values=c("purple", "blue", "red", "orange")) + 
  theme_minimal()
```

This plot was made by averaging the temperature, wind speed, humidity, and precipitation at certain intervals leading up to a wildfire and normalizing the values by the largest value in each respective dataset, in order to better visualize the average change in each. Precipitation by far shows the largest change leading up a fire, making it the most potent predictor. Humidity and wind speed also decrease leading up to a fire while temperature increases. An observed combination of these factors can help increase awareness of and preparation for high fire risk.

#### By Fire Size Class

```{r, echo = FALSE}
ggplot(FiresClean, aes(x = disc_clean_date, fill = fire_size_class)) + 
  geom_density(alpha = .6, color = NA) + 
  facet_wrap(~ fire_size_class) + 
  scale_fill_manual(values = c('orange', 'darkorange', 'darkorange2', 'orangered', 'red', 'brown')) + 
  labs(x = 'Date of Fire Discovery', y = 'Comparative Density') +
  theme_minimal() + 
  theme(legend.position = 'none')

ggplot(FiresClean, aes(x = yday(disc_clean_date), fill = fire_size_class)) + 
  geom_density(alpha = .6, color = NA) + 
  facet_wrap(~ fire_size_class) + 
  scale_fill_manual(values = c('orange', 'darkorange', 'darkorange2', 'orangered', 'red', 'brown')) + 
  scale_x_continuous(breaks = c(1, 60, 121, 182, 244, 305), labels = c('Jan', 'Mar', 'May', 'Jul', 'Sept', 'Nov')) +
  labs(x = 'Date of Fire Discovery', y = 'Comparative Density') + 
  theme_minimal() + 
  theme(legend.position = 'none')
```


#### By Cause of Fire

```{r, echo = FALSE}
ggplot(FiresClean, aes(x = disc_clean_date, fill = causeCat)) + 
  geom_density(alpha = .6, color = NA) + 
  facet_wrap(~ causeCat) + 
  labs(x = 'Date of Fire Discovery', y = 'Comparative Density', fill = 'Fire Cause') +
  theme_minimal() + 
  theme(legend.position = 'none') 

ggplot(FiresClean, aes(x = yday(disc_clean_date), fill = causeCat)) +
  geom_density(alpha = .6, color = NA) + 
  labs(x = 'Date of Fire Discovery', y = 'Comparative Density') +
  facet_wrap(~ causeCat) + 
  scale_x_continuous(breaks = c(1, 60, 121, 182, 244, 305), labels = c('Jan', 'Mar', 'May', 'Jul', 'Sept', 'Nov')) +
  theme_minimal() + 
  theme(legend.position = 'none')
```





